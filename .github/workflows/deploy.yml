name: React + Vite CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  # 1. Job –¥–ª—è —Å–±–æ—Ä–∫–∏ –∏ —Ç–µ—Å—Ç–æ–≤ (CI)
  build-and-test:
    name: Build & Test Client
    # üõ†Ô∏è –§–ò–ö–° #1: –î–æ–±–∞–≤–ª—è–µ–º matrix, —á—Ç–æ–±—ã –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
    strategy:
      matrix:
        node-version: [20.x] # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–¥–Ω—É —Å—Ç–∞–±–∏–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã

    # üõ†Ô∏è FIX #2: –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–π VM GitHub
    runs-on: ubuntu-latest

    steps:
      - name: Pull code to VM Github
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"
          cache-dependency-path: "./package-lock.json"

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: echo 'test' # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å npm test

      - name: Build application
        run: npm run build

      # üõ†Ô∏è –§–ò–ö–° #3: –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (–ø–∞–ø–∫—É dist) –∫–∞–∫ –ê—Ä—Ç–µ—Ñ–∞–∫—Ç
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: client-build-artifact
          path: dist/ # –ü—É—Ç—å –∫ –≤–∞—à–µ–π —Å–æ–±—Ä–∞–Ω–Ω–æ–π –ø–∞–ø–∫–µ

  # 2. Job –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è (CD)
  deploy:
    name: Deploy client to server
    # ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –§–ò–ö–°: –≠—Ç–∞ –∑–∞–¥–∞—á–∞ –¥–æ–ª–∂–Ω–∞ –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –Ω–∞ –≤–∞—à–µ–º —Å–µ—Ä–≤–µ—Ä–µ!
    runs-on: self-hosted

    # ‚ö†Ô∏è –î–û–ë–ê–í–õ–ï–ù–û: –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω—ã—Ö —Å–±–æ—Ä–∫–∏ –∏ —Ç–µ—Å—Ç–æ–≤
    needs: [build-and-test]

    steps:
      # üõ†Ô∏è –§–ò–ö–° #4: –°–∫–∞—á–∏–≤–∞–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –Ω–∞ –Ω–∞—à —Ä–∞–Ω–Ω–µ—Ä
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: client-build-artifact
          path: ./app-to-deploy # –°–∫–∞—á–∏–≤–∞–µ–º –≤ —ç—Ç—É –ø–∞–ø–∫—É

      # üõ†Ô∏è –§–ò–ö–° #5: –ò—Å–ø–æ–ª—å–∑—É–µ–º PM2, —á—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ —Ñ–æ–Ω–µ –∏ –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–Ω–Ω–µ—Ä
      - name: Deploy and Start with PM2
        # –ú—ã –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É, –≥–¥–µ –ª–µ–∂–∞—Ç –Ω–∞—à–∏ —Ñ–∞–π–ª—ã,
        # —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PM2 –∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–µ—Ä–≤–µ—Ä
        run: |
          # 1. –£—Å—Ç–∞–Ω–æ–≤–∏–º PM2 –∏ Serve, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
          npm install -g pm2 serve

          # 2. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤–µ—Ä—Å–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          pm2 delete client-app || true 

          # 3. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É —Å —Ñ–∞–π–ª–∞–º–∏ (–æ–Ω–∏ —Å–∫–∞—á–∞–Ω—ã –≤ ./app-to-deploy)
          # –ü–∞–ø–∫–∞ 'dist' –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ 'app-to-deploy'
          cd ./app-to-deploy

          # 4. –ó–∞–ø—É—Å–∫–∞–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–µ—Ä–≤–µ—Ä 'serve' –¥–ª—è –ø–∞–ø–∫–∏ 'dist' —á–µ—Ä–µ–∑ PM2
          # -s dist –æ–∑–Ω–∞—á–∞–µ—Ç "serve the contents of the dist folder"
          # -l 3000 –æ–∑–Ω–∞—á–∞–µ—Ç "listen on port 3000"
          pm2 start serve --name "client-app" -- -s dist -l 3000
